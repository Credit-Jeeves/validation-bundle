[set parameters]
file="app/config/parameters.yml"
file2="app/config/parameters_prod.yml"
@description="Config %%FILE%% must be edentical to %%FILE2%%"
@class=Hat\Environment\Tester\FilesIdentical
@on.fail=builder/parameters.ini

[remove cache cj]
command="rm -rf app/cache/cj"
@class=Hat\Environment\Builder\ExecuteCommand

[remove cache rj]
command="rm -rf app/cache/rj"
@class=Hat\Environment\Builder\ExecuteCommand

[composer install]
@class=Hat\Environment\Tester\Pass
@on.pass=builder/install.ini

; Checks

[mysql installed]
command=mysql
@class=Hat\Environment\Tester\CommandExists
@description="MySQL must be installed"

[mysql version]
command=mysql --version
version=5.5
@class=Hat\Environment\Tester\CommandVersion
@description="MySQL version must be at least %%VERSION%%"
@depends=mysql installed

[mysql is working]
process=mysqld
@class=Hat\Environment\Tester\Process
@description="MySQL is working"
@depends=mysql version

[pdo installed]
class=PDO
@class=Hat\Environment\Tester\PhpClassExists
@description="PDO must be installed"

[php-fpm is working]
process=php-fpm
@class=Hat\Environment\Tester\Process
@description="NGNIX is working as a process '%%PROCESS%%'"

[php-fpm is working on port]
port=80
ip=127.0.0.1
@class=Hat\Environment\Tester\Socket
@description="NGNIX is working on %%IP%%:%%PORT%%"

[php-fpm answer on request]
port=80
ip=127.0.0.1
request="GET / HTTP/1.1\r\nHost: localhost\r\nConnection: Close\r\n\r\n"
response=nginx
@class=Hat\Environment\Tester\Socket
@description="NGNIX answer on request to %%IP%%:%%PORT%%"

[current dir is writable]
path=.
@class=Hat\Environment\Tester\IsWritable
@description="Current dir must be writable"

[date.timezone setting must be set]
option=date.timezone
regex=/.+/i
@class=Hat\Environment\Tester\PhpIni

[setfacl installed]
command=setfacl
@class=Hat\Environment\Tester\CommandExists
@description="setfacl must be installed"

[getfacl installed]
command=getfacl
@class=Hat\Environment\Tester\CommandExists
@description="getfacl must be installed"

; BUILDS

[check cache permissions]
command=getfacl app/cache
user=nginx
regex="/default:user:%%USER%%:rwx/"
@class=Hat\Environment\Tester\CommandOutput
@on.fail=builder/permissions.ini
@doc="doc/acl_redhat.txt"

[check logs permissions]
command=getfacl app/logs
user=nginx
regex="/default:user:%%USER%%:rwx/"
@class=Hat\Environment\Tester\CommandOutput
@on.fail=builder/permissions.ini
@doc="doc/acl_redhat.txt"

[check insttalation version]
contains=9
file=data/installation
@class=Hat\Environment\Tester\FileContains
@on.fail=builder/installation.ini

[check installation of CreditJeevesSf1]
@class=Hat\Environment\Tester\Pass
@description="CreditJeevesSf1 must be installed"
@on.pass=builder/sf1.ini

[check build db]
@class=Hat\Environment\Tester\Pass
@description="DB must be builded"
@on.pass=builder/db.ini

[check migration]
@class=Hat\Environment\Tester\Pass
@description="DB must be migrated"
@on.pass=builder/migration.ini

[cache clear prod]
command="php bin/console.php cache:clear --env=prod --no-warmup"
@class=Hat\Environment\Builder\ExecuteCommand

[cache clear cli]
command="php bin/console.php cache:clear --env=cli --no-warmup"
@class=Hat\Environment\Builder\ExecuteCommand

[install assetic]
command="php bin/console.php assetic:dump --app=rj"
@class=Hat\Environment\Builder\ExecuteCommand

[install routs for cj]
command="php app/console fos:js-routing:dump --app=cj --env=prod --target=web/bundles/fosjsrouting/js/cj_prod.js"
@class=Hat\Environment\Builder\ExecuteCommand

[install routs for rj]
command="php app/console fos:js-routing:dump --app=rj --env=prod --target=web/bundles/fosjsrouting/js/rj_prod.js"
@class=Hat\Environment\Builder\ExecuteCommand
