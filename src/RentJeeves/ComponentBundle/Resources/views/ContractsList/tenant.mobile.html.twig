<!-- Popup Delete Contract -->
{#<div id="contract-delete" class="pricing-popup dashboard-popup properties-popup">
    <h1>{{ 'contract.delete' | trans() }}</h1>
    <div class="clearfix col-box">
        <div class="col" id="contract-address"></div>
        <div class="footer-button-box">
            <button id="button-contract-delete" class="button buttonFix">
                <span>{{ 'delete' | trans() }}</span>
            </button>
            <button id="button-cancel" class="button grey buttonFix">
                <span>{{ 'cancel' | trans() }}</span>
            </button>
        </div>
    </div>
</div>#}
<!-- end Delete Contract -->
<!-- Loader -->
{#<div id="contract-loader" class="pricing-popup dashboard-popup properties-popup">
    <div class="clearfix col-box popup-loader">
        <center>
            <img src="{{ asset('/bundles/core/images/img_loading.gif') }}" alt="Loading" />
        </center>
    </div>
</div>#}
<!-- endloader -->
    {#<h1>{{ 'current_contracts.title' | trans() }}</h1>#}


<script>


    var contractsJson={{ contractsJson | raw }};
    var paidForArr={{ paidForArr | serialize('json') | raw }};

    $(document).ready(function(){

        $.mobile.changePage('#main')    //users should always start at #main

        prefix="rentjeeves_checkoutbundle_paymenttype_";
        subs=[
          ["amount_label","Rent Amount"], ["paidFor_label","for month of*"],
                ["amountOther_label","Other Amount (Late Fees, etc.)"],
                ["paymentAccount_label","Payment Source"]
        ];

        $.each(subs,function(i,k){
            $("#"+prefix+k[0]).html(k[1])
        })



        $(document).delegate('#opendialog', 'click', function() {
            $('<div>').simpledialog2({
                mode: 'blank',
                headerText: false,
                headerButton: false,
                headerClose: false,
                blankContent :
                "<div style='padding: 5px;'>Are you sure you want to cancel this payment?</div>"+
                "<br><a href='' data-ajax='false' id='confirmCancel' style='text-decoration: none;'>"+
                "<button style='color: white; background: rgb(232,65,65);text-shadow:none; border-radius: 7px;'>Cancel Payment</button></a>" +
                "<a rel='close' href='\#main' data-ajax='false' style='text-decoration: none;'><button style='text-shadow:none; border-radius: 7px;'>Back</button></a>"
            })
        })

        $( ".selector" ).loader({
            disabled: true
        });

        h=$.mobile.getScreenHeight();
        h-=60;
    $(".ui-content").css('min-height',h+'px');
        for (i = 0; i < contractsJson.length;i++) {
            contract=contractsJson[i]
            console.log(contract)
            $("#contractPayTo"+contract.id).html(contract.payToName)
            if(contract.payment){

                $("#cancel"+contract.id).attr("onclick","setTimeout(function(){cancelPayment("+contract.payment.id+"); $('.ui-dialog').hide()},50)")
                        //settimeout hide dialog fixes weird bug with simpledialog

                $.each(payAccounts,function(i,k){
                    if(k.id==contract.payment.paymentAccountId){
                        $("#contractFromAcc"+contract.id).html(k.name)
                    }})
            }else{
                $("#contractFromAccLabel"+contract.id).hide()
            }
            {#
            ^^^^
            contract object does not have payToName
            so we can just use the JSON object to put this in.
            #}
        }

        $("<span>Total to Pay: </span>$<span id='total'></span> ").insertAfter($("#rentjeeves_checkoutbundle_paymenttype_amountOther"))
        $("#rentjeeves_checkoutbundle_paymenttype_total_row").hide()
        $("#rentjeeves_checkoutbundle_paymenttype_amount").onchange=updateTotal;
        $("#rentjeeves_checkoutbundle_paymenttype_amountOther").onchange=updateTotal
        $("#rentjeeves_checkoutbundle_paymenttype_type_label").html("One-Time or Recurring<sup>*</sup>");


    })

    function cancelPayment(i){
        $("#confirmCancel").attr("href","/checkout/cancel/"+i);
    }

    var gId=-1;

    function setupPayForm(id) {

        gId=id;

        $("#errorMsg").html("")
        $("#errorMsg").hide()

        $(".fields-box").css('padding-bottom','10px')

        $("#backToContract").attr("href","#contract"+id)

        var today = new Date();
        var mm = today.getMonth()+1; //January is 0!
        var yyyy = today.getFullYear();


        if(mm<10) {
            mm='0'+mm
        }

        $("#rentjeeves_checkoutbundle_paymenttype_amountOther").val("0.00")

        for (i = 0; i < contractsJson.length;i++) {
            if(contractsJson[i].id==id){


                contract=contractsJson[i]

                if('{{ user.getIsVerified }}'!='passed' && contract.isPidVerificationSkipped==false){
                    $.mobile.changePage('#notVerified')
                    break;
                }else{
                    $.mobile.changePage('#pay')
                }


                a=[]
                for(j=0;j<contract.groupSetting.dueDays.length;j++){
                    a.push([-1,-1,contract.groupSetting.dueDays[j]])
                }

                $('#rentjeeves_checkoutbundle_paymenttype_start_date').datebox({
                    mode: "calbox",
                    afterToday: true,
                    blackDatesRec:[a],
                    defaultValue: new Date(),
                    useFocus :true,
                    useButton:false


                })

                $(document).on("click","#rentjeeves_checkoutbundle_paymenttype_start_date",function(){
                    var viewportwidth = $(window).width();
                    var datepickerwidth = $("#ui-datepicker-div").width();
                    var leftpos = (viewportwidth - datepickerwidth)/2; //Standard centering method
                    $("#ui-datepicker-div").css({left: leftpos,position:'absolute'});
                });

                jQuery('#rentjeeves_checkoutbundle_paymenttype_contractId').val(id);

                console.log(contract)
                paidFor=paidForArr[contract.id]
                $("#rentjeeves_checkoutbundle_paymenttype_paidFor").html("");
                $.each(paidFor,function(index,value){
                    if(contract.payment) {
                        a = ""
                        if (value == contract.payment.paidFor) {
                            a = "selected"
                        }
                    }
                    $("#rentjeeves_checkoutbundle_paymenttype_paidFor").append("<option value='"+index+"'"+a+">"+value+"</option>")
                })

                $("#rentjeeves_checkoutbundle_paymenttype_amount").val(contract.rent)
                $('#rentjeeves_checkoutbundle_paymenttype_total').val(contract.rent)
                $("#payTo").html(contract.payToName);
                $("#contractAddress").html(contract.property.number+" "+contract.property.street+", "+contract.property.district+" "+contract.unit.name)

                $("#rentjeeves_checkoutbundle_paymenttype_dueDate").html("")
                for (i = 1; i < 32; i++) {
                    a = "";
                    if(contract.payment){
                        if (i == contract.payment.dueDate) {
                            a = " selected"
                        }
                    }else if(i==(new Date()).getDate()){
                        a="selected"
                    }
                    $("#rentjeeves_checkoutbundle_paymenttype_dueDate").append("<option" + a + ">" + i + "</option>")
                }


                if(contract.payment) {

                    $("#payRentBttn").html("SAVE CHANGES")

                    $("#rentjeeves_checkoutbundle_paymenttype_paymentAccount").val(contract.payment.paymentAccountId)

                    if (contract.payment.status == "active") {
                        if (contract.payment.type == "recurring") {
                            $("#rentjeeves_checkoutbundle_paymenttype_type").val("recurring")
                            formType(false)
                        } else {
                            $("#rentjeeves_checkoutbundle_paymenttype_type").val("one_time")
                            formType(true);
                        }
                    }

                    $("#rentjeeves_checkoutbundle_paymenttype_type").selectmenu("refresh")


                    $("#rentjeeves_checkoutbundle_paymenttype_startMonth").val(contract.payment.startMonth);
                    $("#rentjeeves_checkoutbundle_paymenttype_startYear").val(contract.payment.startYear);
                    if(contract.payment.endMonth){
                        $("#rentjeeves_checkoutbundle_paymenttype_endMonth").val(contract.payment.endMonth);
                        $("#rentjeeves_checkoutbundle_paymenttype_endYear").val(contract.payment.endYear);
                        whenCancelled(true)
                    }else{
                        whenCancelled(false)
                    }


                    $("#rentjeeves_checkoutbundle_paymenttype_start_date").val(mm+"/"+(contract.payment.dueDate)+"/"+yyyy)
                    $("#rentjeeves_checkoutbundle_paymenttype_dueDate").append("<option value='"+contract.payment.dueDate+"' selected></option>")


                }else{

                    $("#payRentBttn").html("PAY RENT")


                    $("#rentjeeves_checkoutbundle_paymenttype_start_date").val(mm+"/"+((new Date()).getDate())+"/"+yyyy)

                    formType(true)
                    $("#rentjeeves_checkoutbundle_paymenttype_type").val("one_time")
                    $("#rentjeeves_checkoutbundle_paymenttype_startMonth").val((new Date()).getMonth()+1)
                    $("#rentjeeves_checkoutbundle_paymenttype_startYear").val((new Date()).getFullYear())

                    $("#rentjeeves_checkoutbundle_paymenttype_endMonth").val((new Date()).getMonth()+1)
                    $("#rentjeeves_checkoutbundle_paymenttype_endYear").val((new Date()).getFullYear())

                    $("#rentjeeves_checkoutbundle_paymenttype_ends_0").attr("checked",true)
                    $("#rentjeeves_checkoutbundle_paymenttype_ends_1").attr("checked",false)
                    whenCancelled(false)

                    $("#rentjeeves_checkoutbundle_paymenttype_ends_0").checkboxradio("refresh");
                    $("#rentjeeves_checkoutbundle_paymenttype_ends_1").checkboxradio("refresh");

                    $("#rentjeeves_checkoutbundle_paymenttype_paymentAccount").val(payAccounts[0].id)

                }

                $("#rentjeeves_checkoutbundle_paymenttype_type").selectmenu("refresh");
                $("#rentjeeves_checkoutbundle_paymenttype_startYear").selectmenu("refresh");
                $("#rentjeeves_checkoutbundle_paymenttype_startMonth").selectmenu("refresh");
                $("#rentjeeves_checkoutbundle_paymenttype_paidFor").selectmenu("refresh")
                $("#rentjeeves_checkoutbundle_paymenttype_dueDate").selectmenu("refresh")
                $("#rentjeeves_checkoutbundle_paymenttype_endMonth").selectmenu("refresh");
                $("#rentjeeves_checkoutbundle_paymenttype_endYear").selectmenu("refresh");
                $("#rentjeeves_checkoutbundle_paymenttype_dueDate").selectmenu("refresh")
                $("#rentjeeves_checkoutbundle_paymenttype_paymentAccount").selectmenu("refresh")

                $("#rentjeeves_checkoutbundle_paymenttype_paidTo").val(contract.paidTo)


                $("#revEnds").html(contract.finishAt)

                break;
            }
        }

        updateTotal()

    }

</script>



        <div data-role="page" id="main">

            <div data-role="panel" id="panel" style="background: black;">
                <ul data-role="listview">
                    <li><a href="#main" class="menuOptions" style="color: #666 !important;">Current Payments</a></li>
                    <li><a href="#paymentHistory" class="menuOptions">Payment History</a></li>
                    {#<li><a href="bmw.html" class="menuOptions">Payment Sources</a></li>#}
                    <li><a href="logout" class="menuOptions">Logout</a></li>
                </ul>

            </div>

            <div data-role="header" role="banner" class="ui-header ui-bar-inherit">
                <a href="#panel" class="headerButton" data-role="none"><i class="fa fa-bars" style="background: none; color: white; font-size: 22pt;"></i></a>

                <h1 class="ui-title" role="heading" aria-level="1" style="background: transparent;"><img style="width: 100%;" src="/bundles/rjcore/Images/mobile/home-logo.png"></h1>
            </div>

            <div class="ui-content" role="main" style='background-image: url(/bundles/rjcore/Images/mobile/darkblur-bgnd.png); background-size: cover;'>

            <div style="color: white; font-size: 18pt; font-weight: normal; text-shadow: none;">Current Payments</div>
                {#
                <a href="#" class="ui-btn-right ui-btn ui-icon-plus ui-btn-icon-life" data-role="button" role="button"></a>

                #}
            {#
            <div class="addPropertyContainer">
                <center>
                    <a href="{{ path('property_add')}}" class="button small">
                        <span>{{ 'add.property' | trans() }}</span>
                    </a>
                </center>
            </div>
#}
                {% for contract in contracts %}
                    {% if contract.status != 'deleted' and contract.status!='finished' %}
                    <a href="#contract{{ contract.id }}" style="color: rgb(40,40,40); text-decoration: none; font-weight: normal;" data-transition="slide">
            <div onclick="$.mobile.changePage('#contract{{ contract.id }}', { transition:'slide' } );" style="border-radius: 4px;padding: 8px;padding-left: 38px;margin-top: 20px;cursor: pointer; background: #fff; opacity: 0.8;position: relative; line-height: 1.9;">
                <a id="a{{ loop.index }}" href="#contract{{ contract.id }}" style="position: absolute;top: 6px; left: 10px;background: none;border: none; color: #333;"><i class="fa fa-home fa-lg"></i></a>
                <a href="#contract{{ contract.id }}" style="position: absolute; top: 32%; right: 21px;background: none;border: none; color: #eb6024;"><i class="fa fa-chevron-right fa-lg"></i></a></a>
                            <b style="font-size: 16;">{{ contract.full_address|length > 21 ? contract.full_address|slice(0, 21) ~ '...' : contract.full_address  }}</b>
                        <br>
                            <span style="font-size: 14;">{{ contract.rent }}</span>
                    <br>
                {#
                        <b style="font-size: 14;">Due Next: {{ contract.payment_next }}</b>
                #}
                {% if contract.status == 'pending' %}
                   <span style="color: red;">{{ 'contract.status.pending.text' | trans }}</span>
                {% elseif contract.payment_status == 'processing' %}
                    <span style="color: red;">{{ 'contract.status.processing.text' | trans }}</span>

                    {#
                {% elseif contract.status == 'invite' %}
                    {{ 'contract.status.invite.text' | trans }}
                    #}

                {% elseif contract.payment_type == 'recurring' %}
                    Scheduled: {{ contract.payment_due_date }}
                {% elseif contract.payment_type == 'one_time' %}
                    Scheduled: {{  contract.payment_due_date }}
                {% elseif contract.status == 'approved' %}
                    {{ 'contract.status.approved.text' | trans }}
                {% elseif contract.status == 'current' %}
                    Setup your first payment!
                {% elseif contract.status == 'finished' %}
                    {{ 'contract.status.finished.text' | trans }}
                {% else %}
                    {{ contract.status | upper }}
                {% endif %}

                    </div>
                    </a>
                    {% endif %}

                {% endfor %}
            </div>
        </div>

        {% for contract in contracts %}
            <div data-role="page" id="contract{{ contract.id }}">

                <div data-role="header" role="banner" class="ui-header ui-bar-inherit" style="">
                    <a href="#main" data-transition="slide" data-direction="reverse" class="headerButton" data-role="none" style="color: white;">Back</a>
                    <h1 class="ui-title" role="heading" aria-level="1">Current Payment</h1>
                    {% if contract.status != 'pending' %}
                        <a onclick="setupPayForm({{ contract.id }})" class="headerButton" style="border-left: 1px solid white; border-right: none; color: white;" data-role="none">
                            {% if contract.payment_type != 'one_time' and contract.payment_type != 'recurring' %}
                            Pay
                            {% else %}
                            Edit
                            {% endif %}
                        </a>
                    {% endif %}
                </div>

                <div class="ui-content" role="main" style="margin-left: 34px; padding-right: 33px;">
                {% if contract.status != 'deleted' %}

                    <div style="position: absolute;left: 20px;top: 61px;"><i class="fa fa-home fa-lg"></i></div>
                    <div style="font-family: PT Sans Caption; font-size: 14pt; float: right;"><b>{{ contract.full_address }}</b></div>

                    <br><br>


                    <div style="margin-top: 25px; font-family: PT Sans Caption; font-size: 9pt;">AMOUNT</div>
                    <div style="font-family: PT Sans Caption; font-size: 14pt;">{{ contract.rent }}</div>

                    <div style="margin-top: 25px; font-family: PT Sans Caption; font-size: 9pt;">PAY TO</div>
                    <div style="font-family: PT Sans Caption; font-size: 14pt;" id="contractPayTo{{ contract.id }}"></div>

                    <div style="margin-top: 25px; font-family: PT Sans Caption; font-size: 9pt;" id="contractFromAccLabel{{ contract.id }}">FROM ACCOUNT</div>
                    <div style="font-family: PT Sans Caption; font-size: 14pt;" id="contractFromAcc{{ contract.id }}"></div>

                    <br>

                    <div style="color: white; border-radius: 3px; background: #eb6024; padding: 10px; text-shadow: none; font-size: 10pt; font-family: PT Sans Caption;">
                        {% if contract.status == 'pending' %}
                            {{ 'contract.status.pending.text' | trans }}
                        {% elseif contract.payment_status == 'processing' %}
                            {{ 'contract.status.processing.text' | trans }}
                        {% elseif contract.status == 'invite' %}
                            {{ 'contract.status.invite.text' | trans }}
                        {% elseif contract.payment_type == 'recurring' %}
                            {{ 'contract.status.recurring.text' | trans({'%payment_date%': contract.payment_due_date}) }}. You can change this under "Edit".
                        {% elseif contract.payment_type == 'one_time' %}
                            {{ 'contract.status.one_time.text' | trans({'%payment_date%': contract.payment_due_date}) }}. You can change this under "Edit".
                        {% elseif contract.status == 'approved' %}
                            {{ 'contract.status.approved.text' | trans }}
                        {% elseif contract.status == 'current' %}
                            {{ 'contract.status.current.text' | trans }}
                        {% elseif contract.status == 'finished' %}
                            {{ 'contract.status.finished.text' | trans }}
                        {% else %}
                            {{ contract.status | upper }}
                        {% endif %}
                    </div>



                    <br>
                    <br>

                    <div style="font-family: PT Sans Caption; font-size: 10pt; font-weight: bold;">
                    Due Next: {{ contract.payment_next }} {% if contract.payment_type == 'recurring' %}<i class="fa fa-refresh" style="color: #EB6024;"></i>{% endif %}</div>

                {% endif %}
                    <br>
                    {% if contract.status!='pending' and (contract.payment_type=='recurring' or contract.payment_type=='one_time') %}
                    <a id="opendialog" href="#cancel" data-ajax="false" style="text-decoration: none;"><button id='cancel{{ contract.id }}' style="color: white; background: rgb(232,65,65);text-shadow:none; border-radius: 7px;">Cancel Payment</button></a>
                    {% endif %}

                    <a href="#paymentHistory{{ contract.id }}" style="text-decoration: none;"><button{% if contract.status == 'pending' %} disabled{% endif %}>Payment History</button></a>
                    </div>
            </div>
        {% endfor %}


{{ render(controller('RjCheckoutBundle:Component:pay',{'mobile':'true'})) }}


<script type="text/javascript">

    $(document).ready(function() {
        var currentPaymentsViewModel = new CurrentPayments(
            {{ contractsJson | raw }},
            '{{ user.getIsVerified }}',
            {{ paidForArr | serialize('json') | raw }}
        );
        ko.applyBindings(currentPaymentsViewModel, $('#current-payments').get(0));
        {% if isNewUser %}
            $('#contract-pay-1').click();
        {% endif %}
    });


</script>