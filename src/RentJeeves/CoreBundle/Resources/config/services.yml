imports:
    - { resource: address_lookup_services.yml }

parameters:
    data.event_listener.group_settings_listener.class: RentJeeves\DataBundle\EventListener\GroupSettingsListener
    data.event_listener.import_summary.class: RentJeeves\DataBundle\EventListener\ImportSummaryListener
    kernel.listener.command_dispatch.exception.class: RentJeeves\CoreBundle\EventListener\ConsoleExceptionListener
    kernel.listener.command_dispatch.terminate.class: RentJeeves\CoreBundle\EventListener\ConsoleErrorListener
    rental_report.factory.class: RentJeeves\CoreBundle\Report\RentalReportFactory

services:
    sftp_client:
        class: RentJeeves\CoreBundle\Services\SftpClient
        public: false

    hmac.generator:
        abstract: true
        class: RentJeeves\CoreBundle\Services\HMACGenerator

    mri.hmac.generator:
        parent: hmac.generator
        arguments:
            - '@logger'
            - '%mri.digest_key%'
            - 'Digest'

    renttrack.email_canonicalizer:
        class: RentJeeves\CoreBundle\Services\EmailCanonicalizer
        public: false

    fos_user.user_manager.default:
        class: FOS\UserBundle\Doctrine\UserManager
        public: false
        arguments:
            - '@security.encoder_factory'
            - '@fos_user.util.username_canonicalizer'
            - '@renttrack.email_canonicalizer'
            - '@fos_user.entity_manager'
            - '%fos_user.model.user.class%'

    rent.is_due.email_sender:
        class: 'RentJeeves\CoreBundle\Services\Emails\RentIsDueEmailSender'
        arguments:
            em: "@doctrine.orm.default_entity_manager"
            mailer: "@project.mailer"
            logger: "@monolog.logger.rjDueEmail"
            softDeleteableControl: "@soft.deleteable.control"
    property.manager:
        class: RentJeeves\CoreBundle\Services\PropertyManager
        arguments:
            - @doctrine.orm.default_entity_manager
            - @google
            - @address_lookup_service
            - @fp_badaboom.exception_catcher
            - @logger
    data.event_listener.group_settings_listener:
        class: "%data.event_listener.group_settings_listener.class%"
        tags:
            - { name: doctrine.event_listener, event: postLoad, method: postLoad }
        arguments:
            - "%payment_card_fee%"
            - "%payment_bank_fee%"
    data.event_listener.import_summary:
        class: "%data.event_listener.import_summary.class%"
        tags:
            - { name: doctrine.event_listener, event: postPersist, method: postPersist }
    kernel.listener.command_dispatch.exception:
        class: '%kernel.listener.command_dispatch.exception.class%'
        arguments:
            logger: "@logger"
        tags:
            - { name: kernel.event_listener, event: console.exception }
    kernel.listener.command_dispatch.terminate:
        class: '%kernel.listener.command_dispatch.terminate.class%'
        arguments:
            logger: "@logger"
        tags:
            - { name: kernel.event_listener, event: console.terminate }

    data.event_listener.deposit_account:
        class: RentJeeves\CoreBundle\EventListener\DepositAccountListener
        tags:
            - { name: doctrine.event_listener, event: postPersist, method: postPersist }
            - { name: doctrine.event_listener, event: preUpdate, method: preUpdate }
            - { name: doctrine.event_listener, event: postUpdate, method: postUpdate }

    rental_report.factory:
        class: '%rental_report.factory.class%'
        arguments:
            em: "@doctrine.orm.default_entity_manager"
            logger: "@logger"
            propertyManagement: "%property_management%"

    jms_serializer.array_date_time.handler:
        class: RentJeeves\CoreBundle\Handler\DateHandler
        tags:
            - { name: jms_serializer.subscribing_handler }

    jms_serializer.csv_pipe_serialization_visitor:
        class: RentJeeves\CoreBundle\Visitor\CsvSerializationVisitor
        arguments:
            - '|'
            - '"'
        tags:
            - { name: jms_serializer.serialization_visitor, format: csv_pipe }

    merchant_account.repository:
        class: Doctrine\ORM\EntityRepository
        factory_service: doctrine.orm.default_entity_manager
        factory_method: getRepository
        arguments:
            - RentJeeves\DataBundle\Entity\MerchantAccountMigration

    aci_profiles_mapper:
        class: RentJeeves\CoreBundle\PaymentProcessorMigration\Mapper\AciProfileMapper
        public: false
        arguments:
            - %aci.collect_pay.renttrack_application_business_id%
            - %aci.collect_pay.renttrack_virtual_terminal_account%
            - @merchant_account.repository

    aci_profiles_exporter:
        class: RentJeeves\CoreBundle\PaymentProcessorMigration\CsvExporter
        arguments:
            - @doctrine.orm.default_entity_manager
            - @aci_profiles_mapper
            - @jms_serializer
            - @validator

    aci_enrollment_file_deserializer:
        class: RentJeeves\CoreBundle\PaymentProcessorMigration\Deserializer\EnrollmentResponseFileDeserializer
        public: false
        arguments:
            - @logger

    aci_profiles_importer:
        class: RentJeeves\CoreBundle\PaymentProcessorMigration\CsvImporter
        arguments:
            - @doctrine.orm.default_entity_manager
            - @aci_enrollment_file_deserializer
            - @validator
            - @logger

    guzzle_client:
        class: Guzzle\Http\Client

    http_client:
        class: RentJeeves\CoreBundle\HttpClient\HttpClient
        arguments:
            - @guzzle_client
            - @logger

    form.type.entity_hidden:
        class: RentJeeves\CoreBundle\Form\Type\EntityHiddenType
        arguments:
            - @doctrine.orm.default_entity_manager
        tags:
            - { name: form.type, alias: entity_hidden }

    dedupe.contract_movement:
        class: RentJeeves\CoreBundle\Services\ContractMovementManager
        arguments:
            - @doctrine.orm.default_entity_manager
            - @payment_processor.factory
            - @monolog.logger.contract_movement_manager

    dedupe.unit_deduplicator:
        class: RentJeeves\CoreBundle\Services\UnitDeduplicator
        arguments:
            - @dedupe.contract_movement
            - @doctrine.orm.default_entity_manager
            - @monolog.logger.unit_deduplicator

    dedupe.property_deduplicator:
        class: RentJeeves\CoreBundle\Services\PropertyDeduplicator
        arguments:
            - @dedupe.unit_deduplicator
            - @doctrine.orm.default_entity_manager
            - @monolog.logger.property_deduplicator

    renttrack.user_creator:
        class: RentJeeves\CoreBundle\UserManagement\UserCreator
        arguments:
            - '@doctrine.orm.default_entity_manager'
            - '@logger'
            - '@validator'

    renttrack.contract_creator:
        class: RentJeeves\CoreBundle\ContractManagement\ContractCreator

    renttrack.contract_manager:
        class: RentJeeves\CoreBundle\ContractManagement\ContractManager
        arguments:
            - '@renttrack.contract_creator'
            - '@renttrack.user_creator'
            - '@doctrine.orm.default_entity_manager'
            - '@logger'
            - '@validator'
            - '@project.mailer'
