{% extends "LandlordBundle::base.html.twig" %}

{% block content %}
    <div class="sub-menu">
        {{ knp_menu_render('LandlordBundle:Builder:accountingMenu', { 'template': '::menu.html.twig' }) }}
    </div>
    <div class="container-content">
        <div id="action_plan_page">
            <div class="column-middle floatleft">
                <div id="reviewContainer" class="pod-middle pod-border pod-padding shadow">
                    {{
                    include(
                    'LandlordBundle:Accounting:importSteps.html.twig',
                        {
                            'step': 'step3',
                        }
                    )
                    }}
                    <br />
                    <br />
                    <div class="information-box pie-el"  data-bind="visible: ($root.isValidDateFormat() == false)">
                        {{ "import.error.mapping_date"|trans }}
                    </div>
                    <div class="information-box pie-el"  data-bind="visible: ($root.hasException() == true)">
                        <span>{{ "import.description_exception"|trans({'%support_email%':supportEmail}) }}</span>
                        <span data-bind="foreach: $root.rows">
                            <span data-bind="text: unique_key_exception, visible: unique_key_exception != null"></span>
                        </span>
                        <br>
                        <a class="skipException" data-bind="click: $root.skipException">
                            {{ 'import.skip_exception'|trans }}
                        </a>
                    </div>
                    {% image '@LandlordBundle/Resources/public/images/ajax.gif' %}
                        <img src="{{ asset_url }}" class="left" data-bind="visible: $root.showSpinner()" />
                    {% endimage %}
                    <div data-bind="
                            visible: $root.loadDataMessage().length > 0,
                            text: $root.loadDataMessage(),
                            attr: { class: $root.classLoadDataMessage }
                    ">
                    </div>
                    <table id="importTable" class="properties-table zebra-grid" data-bind="visible: $root.isVisibleTable()">
                        <thead>
                        <tr class="properties-th">
                            <th class="pie-el status"><span>{{ 'import.status'|trans }}</span></th>
                            {% if isMultipleProperty == 'true' %}
                                <th class="pie-el unit"><span>{{ 'property'|trans }}*</span></th>
                            {% endif %}
                            <th class="pie-el unit"><span>{{ 'import.unit'|trans }}*</span></th>
                            <th class="pie-el resident">
                                <span>
                                    {{ 'import.residentId'|trans }}*
                                    {% if isMultipleProperty == 'true' %}
                                        <hr />
                                        {{ 'import.unit_id'|trans }}*
                                    {% endif %}
                                </span>
                            </th>
                            <th class="pie-el"><span>{{ 'import.first_name'|trans }}*</span></th>
                            <th class="pie-el"><span>{{ 'import.last_name'|trans }}*</span></th>
                            <th class="pie-el"><span>{{ 'import.email'|trans }}*</span></th>
                            <th class="pie-el">
                                <span>
                                    {{ 'import.rent'|trans }} <hr />
                                    {{ 'common.balance'|trans }}
                                </span>
                            </th>
                            <th class="pie-el dates">
                                <span>
                                    {{ 'import.move_in'|trans }}
                                    <hr />
                                    {{ 'import.lease_end'|trans }}
                                </span>
                            </th>
                            <th class="pie-el action"><span>{{ 'import.action'|trans }}</span></th>
                        </tr>
                        </thead>
                        <tbody data-bind="foreach: $root.rows">
                            {{
                                include(
                                    'LandlordBundle:Accounting:_reviewNewUserWithContract.html.twig',
                                    {
                                    'form': formNewUserWithContract,
                                    'isMultipleProperty': isMultipleProperty
                                    }
                                )
                            }}
                            {{
                                include(
                                    'LandlordBundle:Accounting:_reviewUpdateCreateContract.html.twig',
                                    {
                                    'form': formContract,
                                    'isMultipleProperty': isMultipleProperty
                                    }
                                )
                            }}
                            {{
                                include(
                                    'LandlordBundle:Accounting:_reviewSkip.html.twig',
                                    {
                                        'form': formContractFinish,
                                        'isMultipleProperty': isMultipleProperty
                                    }
                                )
                            }}
                        </tbody>
                    </table>
                    <br />
                    <br />
                    <div class="button-box"  data-bind="visible: $root.isVisibleTable()">
                        {% if importMapping.isNeedManualMapping %}
                            <a href="{{ path("accounting_match_file") }}" class="button small fixed next grey prev">
                                <span>{{ 'pay_popup.step.previous'|trans }}</span>
                            </a>
                        {% else %}
                            <a href="{{ path("accounting_import_file") }}" class="button small fixed next grey prev">
                                <span>{{ 'pay_popup.step.previous'|trans }}</span>
                            </a>
                        {% endif %}
                        <button type="submit"
                                class="button small submitImportFile"
                                data-bind="visible: $root.loadDataMessage().length == 0, click: submitForms"
                        >
                            <span>{{ 'import.review.and.post'|trans }}</span>
                        </button>
                    </div>
                    <div data-bind="if: isFinishReview">
                        <h3 class="finishedTitle">{{ 'import.review.finish'|trans }}</h3>
                    </div>
                </div>
            </div>
            <div class="clear"></div>
        </div>
    </div>

{% endblock %}
{% block head_javascripts %}
    <script type="text/javascript">
        {% autoescape false %}
        var className = 'accountingImport{{  importStorage.getStorageType|capitalize }}';
        var isMultipleProperty = JSON.parse('{{ isMultipleProperty }}');
        var importOnlyException = JSON.parse('{{ importOnlyException }}');
        {% endautoescape %}
    </script>
    {% javascripts
        '@LandlordBundle/Resources/public/js/extend.js'
        '@LandlordBundle/Resources/public/js/accountingImport.js'
        '@LandlordBundle/Resources/public/js/accountingImportCsv.js'
        '@LandlordBundle/Resources/public/js/accountingImportYardi.js'
        '@LandlordBundle/Resources/public/js/accountingImportResman.js'
        '@LandlordBundle/Resources/public/js/accountingImportFactory.js'
    %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}
    {{ parent() }}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets
    '@LandlordBundle/Resources/public/css/submenu.css'
    '@LandlordBundle/Resources/public/css/stepImport.css'
    '@LandlordBundle/Resources/public/css/import.css'
    %}
    <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}
